<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Annual Leave Planner (2026–2027) — Supabase</title>
    <style>
      :root {
        --bg: #0b0d10;
        --card: #141820;
        --muted: #8b93a1;
        --text: #e8edf2;
        --surface: #1b2130;
        --accent: #5b8cff;
        --accent-2: #16c79a;
        --danger: #ff5d6c;
        --outline: #2a3243;
        --chip-bg: #232a3b;
        --today: #2b3348;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Helvetica, Arial;
        color: var(--text);
        background: radial-gradient(
              1200px 700px at 10% -10%,
              #17203a 0%,
              #0b0d10 55%
            )
            fixed,
          var(--bg);
      }
      .hidden {
        display: none !important;
      }
      .container {
        max-width: 1100px;
        margin: 24px auto 80px;
        padding: 0 16px;
      }
      .card {
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.02),
            transparent
          ),
          var(--card);
        border: 1px solid var(--outline);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 20px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .line {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      label {
        font-size: 13px;
        color: var(--muted);
      }
      input[type="date"],
      select,
      input[type="password"] {
        width: 100%;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--outline);
        border-radius: 10px;
        padding: 10px 12px;
        outline: none;
        font-size: 14px;
        margin-bottom: 10px;
        
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: 1px solid var(--outline);
        color: var(--text);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        border-color: transparent;
        background: linear-gradient(180deg, #6fa0ff, #527ffb);
        color: #0b1220;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn.dangerLink {
        border: 1px solid #3b2530;
        background: #2a1420;
        color: #ff9aad;
      }
      .miniBtn {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 8px;
        border: 1px solid var(--outline);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        cursor: pointer;
      }
      .miniBtn.danger {
        background: #2a1420;
        border-color: #3b2530;
        color: #ff9aad;
      }

      /* Header */
      #appHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(
          180deg,
          rgba(15, 18, 28, 0.9),
          rgba(15, 18, 28, 0.66) 60%,
          transparent
        );
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--outline);
        margin-bottom: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent-2);
        box-shadow: 0 0 0 6px rgba(22, 199, 154, 0.15);
      }
      .userBox {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
      }
      .userChip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--chip-bg);
        border: 1px solid var(--outline);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 13px;
      }
      .userSwatch {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid #00000040;
      }

      /* Layout */
      #main {
        display: grid;
        grid-template-columns: 290px 1fr;
        gap: 16px;
      }
      @media (max-width: 900px) {
        #main {
          grid-template-columns: 1fr;
        }
      }

      /* Sidebar */
      #sidebar {
        padding: 14px;
      }
      #sidebar h3 {
        margin: 6px 0 8px;
        font-size: 14px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      .legend {
        display: grid;
        gap: 8px;
      }
      .legendItem {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 10px;
        border: 1px dashed var(--outline);
        background: rgba(255, 255, 255, 0.02);
      }
      .legendSwatch {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 1px solid #00000040;
      }
      .legendName {
        font-size: 14px;
      }
      .note {
        font-size: 13px;
        color: var(--muted);
        line-height: 1.4;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--outline);
        border-radius: 10px;
        padding: 10px;
        margin-top: 10px;
      }

      /* Apply box */
      #applyBox {
        margin-top: 12px;
        border-top: 1px dashed var(--outline);
        padding-top: 12px;
      }
      #applyBox .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      #applyBox .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .hint {
        font-size: 13px;
        color: var(--muted);
      }

      /* Calendar */
      #calendarCard {
        padding: 14px;
      }
      .calHeader {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: space-between;
        padding: 6px 8px 14px;
      }
      .nav {
        display: inline-flex;
        gap: 6px;
      }
      .monthLabel {
        font-weight: 700;
        letter-spacing: 0.3px;
        font-size: 18px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }
      .dow {
        text-align: center;
        font-size: 12px;
        color: var(--muted);
        padding: 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      .cell {
        min-height: 88px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--outline);
        padding: 6px 8px;
        position: relative;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 4px;
        overflow: hidden;
      }
      .cell.disabled {
        background: #12161f;
        color: #5e6777;
        border-style: dashed;
        opacity: 0.75;
      }
      .cell:not(.disabled):hover {
        border-color: #435170;
        box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.12) inset;
        cursor: pointer;
      }
      .dateNum {
        font-size: 13px;
        color: var(--muted);
      }
      .today .dateNum {
        color: #d9e6ff;
        background: var(--today);
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid #3a4563;
      }
      .pill {
        justify-self: start;
        margin-top: 2px;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 999px;
        background: var(--chip-bg);
        border: 1px solid var(--outline);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        max-width: 100%;
      }
      .pill .name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .leftStripe {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        opacity: 0.9;
      }
      .mine {
        border-color: #66e1bc;
        box-shadow: 0 0 0 2px rgba(102, 225, 188, 0.18) inset;
      }
      .taken {
        opacity: 0.98;
      }

      /* Ranges list */
      .list {
        margin-top: 14px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--outline);
        background: rgba(255, 255, 255, 0.02);
      }
      .list h4 {
        margin: 0 0 8px;
        font-size: 14px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      .listItem {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 8px 10px;
        border-bottom: 1px dashed #263149;
        line-height: 1.2;
      }
      .listItem:last-child {
        border-bottom: 0;
      }
      .who {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .whoDot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 1px solid #00000040;
      }
      .whoName {
        font-weight: 600;
        color: #e2ecff;
      }
      .rangeText {
        color: #c9d7f2;
      }
      .rangeActions {
        display: inline-flex;
        gap: 6px;
      }
    </style>
  </head>
  <body>
    <header id="appHeader" class="hidden">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        Annual Leave Planner
        <span class="hint" id="rangeHint"></span>
      </div>
      <div class="userBox">
        <span class="userChip">
          <span class="userSwatch" id="currentUserSwatch"></span>
          <span id="currentUserName"></span>
        </span>
        <button id="logoutBtn" class="btn" title="Sign out">Logout</button>
      </div>
    </header>

    <div class="container">
      <!-- Login -->
      <section id="login" class="card">
        <h1>Sign in</h1>
        <div class="sub">
          Front-end demo auth; leave data is saved in Supabase.
        </div>
        <div class="field">
          <label for="username">User</label>
          <select id="username"></select>
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Enter password" />
        </div>
        <div class="row">
          <button id="loginBtn" class="btn primary">Sign in</button>
          <button id="fillAdmin" class="btn">Use Admin</button>
        </div>
        <div class="hint" style="margin-top: 8px">
          Admin → <code>Admin / Admin@Leave
          
        </div>
      </section>

      <!-- App -->
      <section id="app" class="hidden">
        <div id="main">
          <aside id="sidebar" class="card">
            <h3>Legend</h3>
            <div class="legend" id="legend"></div>

            <div class="note">
              • Click a date to toggle your leave (single-day).<br />
              • Or apply a range below (From → To).<br />
              • One person per date. Everyone can see all leaves.
            </div>

            <div id="applyBox" class="hidden">
              <h3>Apply leave (range)</h3>
              <div class="grid2">
                <div class="field">
                  <label for="fromDate">From</label>
                  <input id="fromDate" type="date" />
                </div>
                <div class="field">
                  <label for="toDate">To</label>
                  <input id="toDate" type="date" />
                </div>
              </div>
              <div class="actions" style="margin-top: 8px">
                <button id="applyBtn" class="btn primary">Apply</button>
                <button id="saveEditBtn" class="btn primary hidden">
                  Save changes
                </button>
                <button id="cancelEditBtn" class="btn hidden">Cancel</button>
                <button id="deleteEditBtn" class="btn dangerLink hidden">
                  Delete range
                </button>
              </div>
              <div id="applyHint" class="hint" style="margin-top: 8px">
                Select start and end dates, then click Apply.
              </div>
            </div>

            <div
              id="adminTools"
              class="hidden"
              style="
                margin-top: 12px;
                border-top: 1px dashed var(--outline);
                padding-top: 12px;
              "
            >
              <h3>Admin tools</h3>
              <div class="line">
                <label for="adminAssign">Assign To</label>
                <select id="adminAssign"></select>
              </div>
              <div class="hint">
                Choose a staff, then click dates to assign. Pick CLEAR to remove
                bookings. Reassigns will ask for confirmation.
              </div>
              <div class="line" style="margin-top: 8px">
                <button id="clearAllBtn" class="btn dangerLink">
                  Clear all bookings
                </button>
              </div>
            </div>
          </aside>

          <main id="calendarCard" class="card">
            <div class="calHeader">
              <div class="nav">
                <button id="prevBtn" class="btn" title="Previous month">
                  ◀
                </button>
                <button id="todayBtn" class="btn">Go to Jan 2026</button>
                <button id="nextBtn" class="btn" title="Next month">▶</button>
              </div>
              <div class="monthLabel" id="monthLabel">January 2026</div>
              <div class="hint">Click a date to book or unbook</div>
            </div>

            <div class="grid" id="dowRow"></div>
            <div class="grid" id="calendarGrid"></div>

            <div class="list">
              <h4 id="listTitle">All taken leave ranges</h4>
              <div id="rangesList"></div>
            </div>
          </main>
        </div>
      </section>
    </div>

    <!-- Supabase + App -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // Supabase config — replace with your project values
      const SUPABASE_URL = "https://clikohrdkrosjjztxgyn.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaWtvaHJka3Jvc2pqenR4Z3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MzE1NjEsImV4cCI6MjA3NjQwNzU2MX0.RKt7TgHiMaYAhtaNMA_DYQoTOGimOVAvUSZiwMF53rA";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Date range
      const START = { y: 2026, m: 0, d: 1 }; // Jan=0
      const END = { y: 2027, m: 0, d: 30 }; // Jan 30, 2027
      const START_DATE = new Date(START.y, START.m, START.d);
      const END_DATE = new Date(END.y, END.m, END.d);
      const DB_RANGE_START = "2026-01-01";
      const DB_RANGE_END = "2027-01-30";

      // Users — your staff and passwords
      const STAFF_COLORS = [
        "#1abc9c",
        "#e74c3c",
        "#3498db",
        "#9b59b6",
        "#f1c40f",
        "#e67e22",
        "#2ecc71",
        "#e84393",
        "#16a085",
        "#34495e",
        "#d35400",
      ];
      const USERS = [
        {
          id: "admin",
          name: "Admin",
          role: "admin",
          password: "Admin@Leave",
          color: "#ffffff",
        },
        {
          id: "s01",
          name: "Ahmed Nabeel",
          role: "staff",
          password: "moNar",
          color: STAFF_COLORS[0],
        },
        {
          id: "s02",
          name: "Ahmed Naufal",
          role: "staff",
          password: "ROpYr",
          color: STAFF_COLORS[1],
        },
        {
          id: "s03",
          name: "Ahmed Falah",
          role: "staff",
          password: "pAGON",
          color: STAFF_COLORS[2],
        },
        {
          id: "s04",
          name: "Ali Rilwan",
          role: "staff",
          password: "naReP",
          color: STAFF_COLORS[3],
        },
        {
          id: "s05",
          name: "Mohamed Salim",
          role: "staff",
          password: "ranGE",
          color: STAFF_COLORS[4],
        },
        {
          id: "s06",
          name: "Ali Shareef",
          role: "staff",
          password: "NFlUD",
          color: STAFF_COLORS[5],
        },
        {
          id: "s07",
          name: "Moosa Mohamed",
          role: "staff",
          password: "iNAtO",
          color: STAFF_COLORS[6],
        },
        {
          id: "s08",
          name: "Ali Arushan",
          role: "staff",
          password: "dviSp",
          color: STAFF_COLORS[7],
        },
        {
          id: "s09",
          name: "Abdulla Rasheed",
          role: "staff",
          password: "THalE",
          color: STAFF_COLORS[8],
        },
        {
          id: "s10",
          name: "Sharafudheen Mohamed",
          role: "staff",
          password: "rcUla",
          color: STAFF_COLORS[9],
        },
        {
          id: "s11",
          name: "Ahmed Ashfaq",
          role: "staff",
          password: "CLeTR",
          color: STAFF_COLORS[10],
        },
      ];
      const USERS_BY_ID = Object.fromEntries(USERS.map((u) => [u.id, u]));

      // State
      let currentUser = null; // {id, name, role, color}
      let leaves = {}; // { 'YYYY-MM-DD': userId }  (from Supabase)
      let view = { y: START.y, m: START.m };
      const STORAGE = { CURRENT_USER: "alp_current_user_v1" };
      let realtimeChannel = null;

      // Edit mode state for range editing
      let editCtx = null; // { uid, start, end } when editing an existing range

      // Utils
      const pad = (n) => (n < 10 ? "0" + n : "" + n);
      const iso = (y, m, d) => `${y}-${pad(m + 1)}-${pad(d)}`;
      const fromISO = (s) => {
        const [Y, M, D] = s.split("-").map(Number);
        return new Date(Y, M - 1, D);
      };
      const fmtLong = (d) =>
        d.toLocaleDateString(undefined, {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      const monthLabel = (y, m) =>
        new Date(y, m, 1).toLocaleDateString(undefined, {
          month: "long",
          year: "numeric",
        });
      const withinRange = (y, m, d) => {
        const dt = new Date(y, m, d);
        return dt >= START_DATE && dt <= END_DATE;
      };
      const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
      const firstDOW = (y, m) => new Date(y, m, 1).getDay();
      const addDays = (date, n) => {
        const d = new Date(date);
        d.setDate(d.getDate() + n);
        return d;
      };
      const isNextDay = (a, b) => {
        const d1 = addDays(fromISO(a), 1),
          d2 = fromISO(b);
        return (
          d1.getFullYear() === d2.getFullYear() &&
          d1.getMonth() === d2.getMonth() &&
          d1.getDate() === d2.getDate()
        );
      };
      const clampViewToRange = () => {
        const cur = new Date(view.y, view.m, 1);
        const min = new Date(START.y, START.m, 1);
        const max = new Date(END.y, END.m, 1);
        if (cur < min) view = { y: START.y, m: START.m };
        if (cur > max) view = { y: END.y, m: END.m };
      };
      const clampISOToDbRange = (s) => {
        if (!s) return s;
        if (s < DB_RANGE_START) return DB_RANGE_START;
        if (s > DB_RANGE_END) return DB_RANGE_END;
        return s;
      };
      const listDatesISO = (startISO, endISO) => {
        const out = [];
        let d = fromISO(startISO);
        const end = fromISO(endISO);
        while (d <= end) {
          out.push(
            `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`
          );
          d.setDate(d.getDate() + 1);
        }
        return out;
      };

      // DOM
      const $login = document.getElementById("login");
      const $loginBtn = document.getElementById("loginBtn");
      const $username = document.getElementById("username");
      const $password = document.getElementById("password");
      const $fillAdmin = document.getElementById("fillAdmin");

      const $header = document.getElementById("appHeader");
      const $rangeHint = document.getElementById("rangeHint");
      const $logout = document.getElementById("logoutBtn");
      const $currentUserName = document.getElementById("currentUserName");
      const $currentUserSwatch = document.getElementById("currentUserSwatch");

      const $app = document.getElementById("app");
      const $legend = document.getElementById("legend");
      const $adminTools = document.getElementById("adminTools");
      const $adminAssign = document.getElementById("adminAssign");
      const $clearAll = document.getElementById("clearAllBtn");

      const $applyBox = document.getElementById("applyBox");
      const $fromDate = document.getElementById("fromDate");
      const $toDate = document.getElementById("toDate");
      const $applyBtn = document.getElementById("applyBtn");
      const $saveEditBtn = document.getElementById("saveEditBtn");
      const $cancelEditBtn = document.getElementById("cancelEditBtn");
      const $deleteEditBtn = document.getElementById("deleteEditBtn");
      const $applyHint = document.getElementById("applyHint");

      const $prev = document.getElementById("prevBtn");
      const $next = document.getElementById("nextBtn");
      const $today = document.getElementById("todayBtn");
      const $monthLabel = document.getElementById("monthLabel");
      const $dow = document.getElementById("dowRow");
      const $grid = document.getElementById("calendarGrid");

      const $rangesList = document.getElementById("rangesList");
      const $listTitle = document.getElementById("listTitle");

      // Init
      (async function init() {
        // Populate UI
        $username.innerHTML = USERS.map(
          (u) => `<option value="${u.id}">${u.name}</option>`
        ).join("");
        $rangeHint.textContent = `• ${fmtLong(START_DATE)} - ${fmtLong(
          END_DATE
        )}`;
        $dow.innerHTML = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
          .map((d) => `<div class="dow">${d}</div>`)
          .join("");
        $legend.innerHTML = USERS.filter((u) => u.role !== "admin")
          .map(
            (u) => `
      <div class="legendItem"><span class="legendSwatch" style="background:${u.color}"></span><span class="legendName">${u.name}</span></div>
    `
          )
          .join("");
        $adminAssign.innerHTML = [
          `<option value="">— Select —</option>`,
          `<option value="__CLEAR__">CLEAR (remove booking)</option>`,
          ...USERS.filter((u) => u.role !== "admin").map(
            (u) => `<option value="${u.id}">${u.name}</option>`
          ),
        ].join("");

        // Inputs min/max
        [$fromDate, $toDate].forEach((inp) => {
          inp.min = DB_RANGE_START;
          inp.max = DB_RANGE_END;
        });

        // Events
        $loginBtn.addEventListener("click", onLogin);
        $fillAdmin.addEventListener("click", () => {
          $username.value = "admin";
          $password.value = "Admin@Leave";
        });
        $logout.addEventListener("click", onLogout);
        $prev.addEventListener("click", () => {
          view.m--;
          if (view.m < 0) {
            view.m = 11;
            view.y--;
          }
          clampViewToRange();
          render();
        });
        $next.addEventListener("click", () => {
          view.m++;
          if (view.m > 11) {
            view.m = 0;
            view.y++;
          }
          clampViewToRange();
          render();
        });
        $today.addEventListener("click", () => {
          view = { y: START.y, m: START.m };
          render();
        });
        $clearAll.addEventListener("click", onClearAll);

        // Range form events
        $fromDate.addEventListener("change", onRangeInputChange);
        $toDate.addEventListener("change", onRangeInputChange);
        $applyBtn.addEventListener("click", onApplyRange);
        $saveEditBtn.addEventListener("click", onSaveEditRange);
        $cancelEditBtn.addEventListener("click", exitEditMode);
        $deleteEditBtn.addEventListener("click", onDeleteEditRange);

        // Load leaves + realtime
        const savedUserId = localStorage.getItem(STORAGE.CURRENT_USER);
        await loadLeavesFromDB();
        subscribeRealtime();

        if (savedUserId && USERS_BY_ID[savedUserId]) {
          currentUser = USERS_BY_ID[savedUserId];
          showApp();
        } else {
          showLogin();
        }
      })();

      function showLogin() {
        $login.classList.remove("hidden");
        $app.classList.add("hidden");
        $header.classList.add("hidden");
        $password.value = "";
      }

      function showApp() {
        $login.classList.add("hidden");
        $app.classList.remove("hidden");
        $header.classList.remove("hidden");
        $currentUserName.textContent = currentUser.name;
        $currentUserSwatch.style.background = currentUser.color || "#999";

        // Staff get range-apply box; admin keeps admin tools
        const isAdmin = currentUser.role === "admin";
        $applyBox.classList.toggle("hidden", isAdmin); // hide for admin
        $adminTools.classList.toggle("hidden", !isAdmin);

        // Default range inputs
        $fromDate.value = DB_RANGE_START;
        $toDate.value = DB_RANGE_START;
        $applyHint.textContent =
          "Select start and end dates, then click Apply.";

        render();
      }

      // Auth (front-end demo only)
      function onLogin() {
        const id = $username.value;
        const pwd = $password.value.trim();
        const user = USERS_BY_ID[id];
        if (!user) return alert("Unknown user.");
        if (pwd !== user.password) return alert("Incorrect password.");

        currentUser = user;
        localStorage.setItem(STORAGE.CURRENT_USER, user.id);
        showApp();
      }
      function onLogout() {
        currentUser = null;
        localStorage.removeItem(STORAGE.CURRENT_USER);
        exitEditMode();
        showLogin();
      }

      // DB: Load + Realtime
      async function loadLeavesFromDB() {
        const { data, error } = await supabase
          .from("leaves")
          .select("date, staff_id")
          .gte("date", DB_RANGE_START)
          .lte("date", DB_RANGE_END);
        if (error) {
          console.error("Error loading leaves:", error);
          return;
        }
        leaves = {};
        for (const row of data) leaves[row.date] = row.staff_id;
        render();
      }
      function subscribeRealtime() {
        if (realtimeChannel) return;
        realtimeChannel = supabase
          .channel("leaves-changes")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "leaves" },
            (payload) => {
              if (
                payload.eventType === "INSERT" ||
                payload.eventType === "UPDATE"
              ) {
                const row = payload.new;
                leaves[row.date] = row.staff_id;
              } else if (payload.eventType === "DELETE") {
                const row = payload.old;
                delete leaves[row.date];
              }
              render();
            }
          )
          .subscribe();
      }

      // Render
      function render() {
        $monthLabel.textContent = monthLabel(view.y, view.m);
        renderGrid();
        renderRangesList();
        updateNavButtons();
      }
      function updateNavButtons() {
        const min = new Date(START.y, START.m, 1);
        const max = new Date(END.y, END.m, 1);
        const cur = new Date(view.y, view.m, 1);
        $prev.disabled = cur <= min;
        $next.disabled = cur >= max;
      }
      function renderGrid() {
        $grid.innerHTML = "";
        const y = view.y,
          m = view.m;
        const first = firstDOW(y, m);
        const dim = daysInMonth(y, m);

        let cells = [];
        const prevMonth = (m - 1 + 12) % 12;
        const prevYear = m === 0 ? y - 1 : y;
        const prevDim = daysInMonth(prevYear, prevMonth);

        // Leading
        for (let i = 0; i < first; i++) {
          const d = prevDim - first + 1 + i;
          cells.push(
            cellHTML(prevYear, prevMonth, d, {
              disabled: true,
              idate: iso(prevYear, prevMonth, d),
            })
          );
        }
        // Current
        for (let d = 1; d <= dim; d++) {
          const disabled = !withinRange(y, m, d);
          cells.push(cellHTML(y, m, d, { disabled, idate: iso(y, m, d) }));
        }
        // Trailing
        const remaining = Math.ceil(cells.length / 7) * 7 - cells.length;
        const nextMonth = (m + 1) % 12;
        const nextYear = m === 11 ? y + 1 : y;
        for (let d = 1; d <= remaining; d++) {
          cells.push(
            cellHTML(nextYear, nextMonth, d, {
              disabled: true,
              idate: iso(nextYear, nextMonth, d),
            })
          );
        }

        $grid.innerHTML = cells.join("");
        document.querySelectorAll(".cell").forEach(($c) => {
          if ($c.classList.contains("disabled")) return;
          $c.addEventListener("click", () => onDayClick($c.dataset.date));
        });
      }
      function cellHTML(y, m, d, { disabled, idate }) {
        const now = new Date();
        const isToday =
          now.getFullYear() === y &&
          now.getMonth() === m &&
          now.getDate() === d;
        const bookedBy = leaves[idate];
        const user = bookedBy ? USERS_BY_ID[bookedBy] : null;
        const mine = user && currentUser && user.id === currentUser.id;

        const classes = ["cell"];
        if (disabled) classes.push("disabled");
        if (isToday) classes.push("today");
        if (mine) classes.push("mine");
        if (bookedBy) classes.push("taken");

        const leftStripe = user
          ? `<span class="leftStripe" style="background:${user.color}"></span>`
          : "";
        const pill = user
          ? `<span class="pill" title="Taken by ${user.name}"><span class="name" style="color:${user.color}">${user.name}</span></span>`
          : "";

        return `
      <div class="${classes.join(" ")}" data-date="${idate}" title="${idate}${
          user ? " — " + user.name : ""
        }">
        ${leftStripe}
        <div class="dateNum">${d}</div>
        ${pill}
      </div>
    `;
      }

      // Click handling (single-day toggle)
      async function onDayClick(idate) {
        if (!currentUser) return;
        const isAdmin = currentUser.role === "admin";
        const bookedBy = leaves[idate];

        if (isAdmin) {
          const sel = $adminAssign.value;
          if (!sel) {
            if (bookedBy) {
              const u = USERS_BY_ID[bookedBy];
              if (
                confirm(
                  `${fmtLong(fromISO(idate))} is taken by ${u.name}. Clear it?`
                )
              ) {
                await dbDeleteDay(idate);
              }
            }
            return;
          }
          if (sel === "__CLEAR__") {
            if (bookedBy) await dbDeleteDay(idate);
            return;
          }
          if (bookedBy && bookedBy !== sel) {
            const fromU = USERS_BY_ID[bookedBy];
            const toU = USERS_BY_ID[sel];
            const ok = confirm(
              `Reassign ${fmtLong(fromISO(idate))} from ${fromU.name} to ${
                toU.name
              }?`
            );
            if (!ok) return;
          }
          await dbUpsertDay(idate, sel);
          return;
        }

        // Staff: toggle own booking
        if (!bookedBy) {
          await dbInsertDay(idate, currentUser.id);
          return;
        }
        if (bookedBy === currentUser.id) {
          await dbDeleteDay(idate);
          return;
        }
        const u = USERS_BY_ID[bookedBy];
        alert(
          `${fmtLong(fromISO(idate))} is already taken by ${
            u.name
          }. Overlapping leaves are not allowed.`
        );
      }

      // Apply box: range selection
      function onRangeInputChange() {
        let s = clampISOToDbRange($fromDate.value);
        let e = clampISOToDbRange($toDate.value);
        if (s && e && e < s) e = s;
        $fromDate.value = s || "";
        $toDate.value = e || "";
        if (s && e) {
          const days = listDatesISO(s, e).length;
          $applyHint.textContent = `Selected ${days} day(s): ${fmtLong(
            fromISO(s)
          )} → ${fmtLong(fromISO(e))}`;
        }
      }
      async function onApplyRange() {
        if (!currentUser || currentUser.role !== "staff") return;
        const s = $fromDate.value,
          e = $toDate.value;
        if (!s || !e) return alert("Please select both From and To dates.");
        const days = listDatesISO(s, e).length;
        const ok = confirm(
          `Apply leave for ${currentUser.name}\n${fmtLong(
            fromISO(s)
          )} → ${fmtLong(fromISO(e))} (${days} day(s))?`
        );
        if (!ok) return;
        disableApplyButtons(true);
        try {
          await applyRangeForUser(currentUser.id, s, e);
          exitEditMode();
        } finally {
          disableApplyButtons(false);
        }
      }

      function enterEditMode(uid, start, end) {
        editCtx = { uid, start, end };
        $fromDate.value = start;
        $toDate.value = end;
        onRangeInputChange();
        // Show edit controls
        $applyBtn.classList.add("hidden");
        $saveEditBtn.classList.remove("hidden");
        $cancelEditBtn.classList.remove("hidden");
        $deleteEditBtn.classList.remove("hidden");
        // Hint
        const who = USERS_BY_ID[uid]?.name || "Staff";
        $applyHint.textContent = `Editing: ${who} — ${fmtLong(
          fromISO(start)
        )} → ${fmtLong(fromISO(end))}`;
        // Ensure box visible (staff only; admin won’t see box)
        if (currentUser.role === "staff")
          $applyBox.scrollIntoView({ behavior: "smooth", block: "center" });
      }
      function exitEditMode() {
        editCtx = null;
        $saveEditBtn.classList.add("hidden");
        $cancelEditBtn.classList.add("hidden");
        $deleteEditBtn.classList.add("hidden");
        $applyBtn.classList.remove("hidden");
        $applyHint.textContent =
          "Select start and end dates, then click Apply.";
      }
      async function onSaveEditRange() {
        if (!editCtx) return;
        const { uid, start: oldStart, end: oldEnd } = editCtx;
        if (!currentUser) return;
        const isOwner = currentUser.id === uid;
        const isAdmin = currentUser.role === "admin";
        if (!isOwner && !isAdmin)
          return alert("You can only edit your own leave.");
        const newStart = $fromDate.value,
          newEnd = $toDate.value;
        if (!newStart || !newEnd)
          return alert("Please select both From and To dates.");
        const whoName = USERS_BY_ID[uid]?.name || "Staff";
        const ok = confirm(
          `Save changes for ${whoName}?\n${fmtLong(
            fromISO(oldStart)
          )} → ${fmtLong(fromISO(oldEnd))}\nbecomes\n${fmtLong(
            fromISO(newStart)
          )} → ${fmtLong(fromISO(newEnd))}`
        );
        if (!ok) return;
        disableApplyButtons(true);
        try {
          await editRangeForStaff(uid, oldStart, oldEnd, newStart, newEnd);
          exitEditMode();
        } finally {
          disableApplyButtons(false);
        }
      }
      async function onDeleteEditRange() {
        if (!editCtx) return;
        const { uid, start, end } = editCtx;
        if (!currentUser) return;
        const isOwner = currentUser.id === uid;
        const isAdmin = currentUser.role === "admin";
        if (!isOwner && !isAdmin)
          return alert("You can only delete your own leave.");
        const whoName = USERS_BY_ID[uid]?.name || "Staff";
        const days = listDatesISO(start, end).length;
        const ok = confirm(
          `Delete ${whoName}'s leave?\n${fmtLong(fromISO(start))} → ${fmtLong(
            fromISO(end)
          )} (${days} day(s))`
        );
        if (!ok) return;
        disableApplyButtons(true);
        try {
          await deleteRangeForStaff(uid, start, end);
          exitEditMode();
        } finally {
          disableApplyButtons(false);
        }
      }
      function disableApplyButtons(disabled) {
        [
          $applyBtn,
          $saveEditBtn,
          $cancelEditBtn,
          $deleteEditBtn,
          $fromDate,
          $toDate,
        ].forEach((el) => {
          if (el) el.disabled = disabled;
        });
      }

      // DB helpers (single day)
      async function dbInsertDay(dateISO, staffId) {
        const { error } = await supabase
          .from("leaves")
          .insert({ date: dateISO, staff_id: staffId });
        if (error) {
          if (error.code === "23505") {
            const by = leaves[dateISO]
              ? USERS_BY_ID[leaves[dateISO]]?.name || "someone else"
              : "someone else";
            alert(`${fmtLong(fromISO(dateISO))} was just booked by ${by}.`);
          } else {
            console.error("Insert error:", error);
            alert("Could not save. Please try again.");
          }
        }
      }
      async function dbUpsertDay(dateISO, staffId) {
        const { error } = await supabase
          .from("leaves")
          .upsert({ date: dateISO, staff_id: staffId }, { onConflict: "date" });
        if (error) {
          console.error("Upsert error:", error);
          alert("Could not assign. Please try again.");
        }
      }
      async function dbDeleteDay(dateISO) {
        const { error } = await supabase
          .from("leaves")
          .delete()
          .eq("date", dateISO);
        if (error) {
          console.error("Delete error:", error);
          alert("Could not remove. Please try again.");
        }
      }

      // DB helpers (range)
      async function applyRangeForUser(staffId, startISO, endISO) {
        // Pre-check conflicts
        const { data, error } = await supabase
          .from("leaves")
          .select("date, staff_id")
          .gte("date", startISO)
          .lte("date", endISO);
        if (error) {
          console.error(error);
          alert("Could not check availability.");
          return;
        }

        const conflicts = data.filter((r) => r.staff_id !== staffId);
        if (conflicts.length) {
          const c = conflicts[0];
          const by = USERS_BY_ID[c.staff_id]?.name || "another staff";
          return alert(
            `${fmtLong(
              fromISO(c.date)
            )} is already taken by ${by}. Overlapping leaves are not allowed.`
          );
        }

        // Insert only missing dates
        const alreadyMine = new Set(
          data.filter((r) => r.staff_id === staffId).map((r) => r.date)
        );
        const all = listDatesISO(startISO, endISO);
        const toInsert = all
          .filter((d) => !alreadyMine.has(d))
          .map((d) => ({ date: d, staff_id: staffId }));
        if (!toInsert.length) {
          alert("You already have leave for the selected range.");
          return;
        }

        const ins = await supabase.from("leaves").insert(toInsert);
        if (ins.error) {
          if (ins.error.code === "23505") {
            alert(
              "Some dates were just taken by someone else. Please refresh and try again."
            );
          } else {
            console.error(ins.error);
            alert("Could not apply leave. Please try again.");
          }
        }
      }

      async function deleteRangeForStaff(staffId, startISO, endISO) {
        const { error } = await supabase
          .from("leaves")
          .delete()
          .gte("date", startISO)
          .lte("date", endISO)
          .eq("staff_id", staffId);
        if (error) {
          console.error(error);
          alert("Could not delete leave.");
        }
      }

      async function editRangeForStaff(
        staffId,
        oldStart,
        oldEnd,
        newStart,
        newEnd
      ) {
        // 1) Check new range conflicts
        const chk = await supabase
          .from("leaves")
          .select("date, staff_id")
          .gte("date", newStart)
          .lte("date", newEnd);
        if (chk.error) {
          console.error(chk.error);
          alert("Could not check availability.");
          return;
        }
        const conflicts = chk.data.filter((r) => r.staff_id !== staffId);
        if (conflicts.length) {
          const c = conflicts[0];
          const by = USERS_BY_ID[c.staff_id]?.name || "another staff";
          return alert(
            `${fmtLong(fromISO(c.date))} is already taken by ${by}.`
          );
        }

        // 2) Insert missing new dates (skip ones already mine)
        const mineSet = new Set(
          chk.data.filter((r) => r.staff_id === staffId).map((r) => r.date)
        );
        const newAll = listDatesISO(newStart, newEnd);
        const toInsert = newAll
          .filter((d) => !mineSet.has(d))
          .map((d) => ({ date: d, staff_id: staffId }));
        if (toInsert.length) {
          const ins = await supabase.from("leaves").insert(toInsert);
          if (ins.error) {
            if (ins.error.code === "23505") {
              alert(
                "Some dates were just taken by someone else. Please try again."
              );
            } else {
              console.error(ins.error);
              alert("Could not save changes.");
            }
            return;
          }
        }

        // 3) Delete old dates that are no longer in new range
        const oldAll = listDatesISO(oldStart, oldEnd);
        const toDelete = oldAll.filter((d) => !newAll.includes(d));
        if (toDelete.length) {
          const del = await supabase
            .from("leaves")
            .delete()
            .in("date", toDelete)
            .eq("staff_id", staffId);
          if (del.error) {
            console.error(del.error);
            alert("Could not cleanup old days (changes partially applied).");
          }
        }
      }

      // Ranges list (frozen across months) with Edit/Delete for owner (and admin)
      function renderRangesList() {
        // Build ranges per staff across entire dataset
        const entries = Object.entries(leaves)
          .filter(([date, uid]) => !!USERS_BY_ID[uid])
          .sort((a, b) => (a[0] < b[0] ? -1 : 1)); // sort by date

        const ranges = [];
        let cur = null;
        for (const [dateStr, uid] of entries) {
          if (!cur) {
            cur = { uid, start: dateStr, end: dateStr };
            continue;
          }
          if (uid === cur.uid && isNextDay(cur.end, dateStr)) {
            cur.end = dateStr;
          } else {
            ranges.push(cur);
            cur = { uid, start: dateStr, end: dateStr };
          }
        }
        if (cur) ranges.push(cur);

        // Sort ranges chronologically
        ranges.sort((r1, r2) =>
          r1.start < r2.start ? -1 : r1.start > r2.start ? 1 : 0
        );

        $listTitle.textContent = `All taken leave ranges (${fmtLong(
          START_DATE
        )} — ${fmtLong(END_DATE)})`;
        if (ranges.length === 0) {
          $rangesList.innerHTML = `<div class="hint">No leave ranges yet.</div>`;
          return;
        }

        const html = ranges
          .map((r) => {
            const u = USERS_BY_ID[r.uid];
            const start = fmtLong(fromISO(r.start));
            const end = fmtLong(fromISO(r.end));
            const canManage =
              currentUser &&
              (currentUser.role === "admin" || currentUser.id === r.uid);
            return `
        <div class="listItem" data-uid="${r.uid}" data-start="${
              r.start
            }" data-end="${r.end}">
          <div class="who">
            <span class="whoDot" style="background:${u.color}"></span>
            <span class="whoName">${u.name}</span>
            <span class="rangeText">— ${start} → ${end}</span>
          </div>
          <div class="rangeActions">
            ${
              canManage && currentUser.role === "staff"
                ? `
              <button class="miniBtn editBtn">Edit</button>
              <button class="miniBtn danger deleteBtn">Delete</button>
            `
                : ""
            }
            ${
              canManage && currentUser.role === "admin"
                ? `
              <!-- Admin already has tools; still allow quick actions -->
              <button class="miniBtn editBtn">Edit</button>
              <button class="miniBtn danger deleteBtn">Delete</button>
            `
                : ""
            }
          </div>
        </div>
      `;
          })
          .join("");
        $rangesList.innerHTML = html;

        // Bind Edit/Delete buttons
        $rangesList.querySelectorAll(".editBtn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const row = e.target.closest(".listItem");
            const uid = row.dataset.uid,
              start = row.dataset.start,
              end = row.dataset.end;
            // Staff can only edit their own (admin can edit anyone)
            if (currentUser.role !== "admin" && currentUser.id !== uid) {
              alert("You can only edit your own leave.");
              return;
            }
            if ($applyBox.classList.contains("hidden")) {
              alert(
                "Edit is available for staff only in this panel. Admin can reassign via Admin tools."
              );
              return;
            }
            enterEditMode(uid, start, end);
          });
        });
        $rangesList.querySelectorAll(".deleteBtn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const row = e.target.closest(".listItem");
            const uid = row.dataset.uid,
              start = row.dataset.start,
              end = row.dataset.end;
            if (currentUser.role !== "admin" && currentUser.id !== uid) {
              alert("You can only delete your own leave.");
              return;
            }
            const whoName = USERS_BY_ID[uid]?.name || "Staff";
            const days = listDatesISO(start, end).length;
            const ok = confirm(
              `Delete ${whoName}'s leave?\n${fmtLong(
                fromISO(start)
              )} → ${fmtLong(fromISO(end))} (${days} day(s))`
            );
            if (!ok) return;
            await deleteRangeForStaff(uid, start, end);
          });
        });
      }

      // Admin: clear all bookings in range
      async function onClearAll() {
        const count = Object.keys(leaves).length;
        if (count === 0) {
          alert("There are no bookings to clear.");
          return;
        }
        const ok = confirm(
          `Clear all ${count} booking(s) between ${DB_RANGE_START} and ${DB_RANGE_END}?`
        );
        if (!ok) return;
        const { error } = await supabase
          .from("leaves")
          .delete()
          .gte("date", DB_RANGE_START)
          .lte("date", DB_RANGE_END);
        if (error) {
          console.error("Clear all error:", error);
          alert("Could not clear bookings.");
        }
      }
    </script>
  </body>
</html>
