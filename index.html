<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Annual Leave Planner (2026–2027) — Supabase</title>
    <style>
      :root {
        --bg: #0b0d10;
        --card: #141820;
        --muted: #8b93a1;
        --text: #e8edf2;
        --surface: #1b2130;
        --accent: #5b8cff;
        --accent-2: #16c79a;
        --danger: #ff5d6c;
        --outline: #2a3243;
        --chip-bg: #232a3b;
        --today: #2b3348;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Helvetica, Arial;
        color: var(--text);
        background: radial-gradient(
              1200px 700px at 10% -10%,
              #17203a 0%,
              #0b0d10 55%
            )
            fixed,
          var(--bg);
      }
      .hidden {
        display: none !important;
      }
      .container {
        max-width: 1100px;
        margin: 24px auto 80px;
        padding: 0 16px;
      }
      .card {
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.02),
            transparent
          ),
          var(--card);
        border: 1px solid var(--outline);
        border-radius: 16px;
        box-shadow: var(--shadow);
      }
      /* Login */
      #login {
        max-width: 520px;
        margin: 80px auto;
        padding: 28px;
      }
      #login h1 {
        margin: 0 0 4px;
        font-size: 24px;
      }
      .sub {
        color: var(--muted);
        margin-bottom: 18px;
        font-size: 14px;
      }
      .row {
        display: flex;
        gap: 12px;
      }
      .field {
        display: grid;
        gap: 6px;
        margin-bottom: 14px;
      }
      label {
        font-size: 13px;
        color: var(--muted);
      }
      select,
      input[type="password"] {
        width: 100%;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--outline);
        border-radius: 10px;
        padding: 12px;
        outline: none;
        font-size: 15px;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: 1px solid var(--outline);
        color: var(--text);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        padding: 12px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        border-color: transparent;
        background: linear-gradient(180deg, #6fa0ff, #527ffb);
        color: #0b1220;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .helper {
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
      }
      .helper code {
        background: var(--surface);
        border: 1px solid var(--outline);
        padding: 2px 6px;
        border-radius: 6px;
        color: #cfe3ff;
      }

      /* Header */
      #appHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(
          180deg,
          rgba(15, 18, 28, 0.9),
          rgba(15, 18, 28, 0.66) 60%,
          transparent
        );
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--outline);
        margin-bottom: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent-2);
        box-shadow: 0 0 0 6px rgba(22, 199, 154, 0.15);
      }
      .userBox {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
      }
      .userChip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--chip-bg);
        border: 1px solid var(--outline);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 13px;
      }
      .userSwatch {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid #00000040;
      }

      /* Layout */
      #main {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 16px;
      }
      @media (max-width: 900px) {
        #main {
          grid-template-columns: 1fr;
        }
      }

      /* Sidebar */
      #sidebar {
        padding: 14px;
      }
      #sidebar h3 {
        margin: 6px 0 8px;
        font-size: 14px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      .legend {
        display: grid;
        gap: 8px;
      }
      .legendItem {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 10px;
        border: 1px dashed var(--outline);
        background: rgba(255, 255, 255, 0.02);
      }
      .legendSwatch {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 1px solid #00000040;
      }
      .legendName {
        font-size: 14px;
      }

      /* Calendar */
      #calendarCard {
        padding: 14px;
      }
      .calHeader {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: space-between;
        padding: 6px 8px 14px;
      }
      .nav {
        display: inline-flex;
        gap: 6px;
      }
      .monthLabel {
        font-weight: 700;
        letter-spacing: 0.3px;
        font-size: 18px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }
      .dow {
        text-align: center;
        font-size: 12px;
        color: var(--muted);
        padding: 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      .cell {
        min-height: 88px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--outline);
        padding: 6px 8px;
        position: relative;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 4px;
        overflow: hidden;
      }
      .cell.disabled {
        background: #12161f;
        color: #5e6777;
        border-style: dashed;
        opacity: 0.75;
      }
      .cell:not(.disabled):hover {
        border-color: #435170;
        box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.12) inset;
        cursor: pointer;
      }
      .dateNum {
        font-size: 13px;
        color: var(--muted);
      }
      .today .dateNum {
        color: #d9e6ff;
        background: var(--today);
        padding: 2px 7px;
        border-radius: 999px;
        border: 1px solid #3a4563;
      }
      .pill {
        justify-self: start;
        margin-top: 2px;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 999px;
        background: var(--chip-bg);
        border: 1px solid var(--outline);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        max-width: 100%;
      }
      .pill .name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .leftStripe {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        opacity: 0.9;
      }
      .mine {
        border-color: #66e1bc;
        box-shadow: 0 0 0 2px rgba(102, 225, 188, 0.18) inset;
      }
      .taken {
        opacity: 0.98;
      }

      /* Frozen ranges list */
      .list {
        margin-top: 14px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--outline);
        background: rgba(255, 255, 255, 0.02);
      }
      .list h4 {
        margin: 0 0 8px;
        font-size: 14px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }
      .listItem {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-bottom: 1px dashed #263149;
        line-height: 1.2;
      }
      .listItem:last-child {
        border-bottom: 0;
      }
      .whoDot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 1px solid #00000040;
      }
      .whoName {
        font-weight: 600;
        color: #e2ecff;
      }
      .rangeText {
        color: #c9d7f2;
      }

      /* Admin tools */
      #adminTools {
        display: grid;
        gap: 10px;
        border-top: 1px dashed var(--outline);
        padding-top: 12px;
        margin-top: 12px;
      }
      #adminTools .line {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      #adminTools select {
        background: var(--surface);
        border: 1px solid var(--outline);
        color: var(--text);
        padding: 10px 10px;
        border-radius: 10px;
      }
      .dangerLink {
        border: 1px solid #3b2530;
        background: #2a1420;
        color: #ff9aad;
      }
    </style>
  </head>
  <body>
    <header id="appHeader" class="hidden">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        Annual Leave Planner
        <span class="hint" id="rangeHint"></span>
      </div>
      <div class="userBox">
        <span class="userChip">
          <span class="userSwatch" id="currentUserSwatch"></span>
          <span id="currentUserName"></span>
        </span>
        <button id="logoutBtn" class="btn" title="Sign out">Logout</button>
      </div>
    </header>

    <div class="container">
      <!-- Login -->
      <section id="login" class="card">
        <h1>Sign in</h1>
        <div class="sub">
          Front-end demo auth; leave data is saved in Supabase.
        </div>
        <div class="field">
          <label for="username">User</label>
          <select id="username"></select>
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Enter password" />
        </div>
        <div class="row">
          <button id="loginBtn" class="btn primary">Sign in</button>
          <button id="fillAdmin" class="btn">Use Admin</button>
        </div>
        <div class="helper">
          Admin → <code>Admin / Admin@Leave</code> • Example →
          <code>Ahmed Nabeel / moNar</code>
        </div>
      </section>

      <!-- App -->
      <section id="app" class="hidden">
        <div id="main">
          <aside id="sidebar" class="card">
            <h3>Legend</h3>
            <div class="legend" id="legend"></div>
            <div class="note">
              • Click a date to toggle your leave.<br />
              • Only one person can take a given day (no overlaps).<br />
              • Everyone can see all taken leaves.<br />
              • Admin can assign or clear any day.
            </div>

            <div id="adminTools" class="hidden">
              <h3>Admin tools</h3>
              <div class="line">
                <label for="adminAssign">Assign To</label>
                <select id="adminAssign"></select>
              </div>
              <div class="line">
                <button id="clearAllBtn" class="btn dangerLink">
                  Clear all bookings
                </button>
              </div>
            </div>
          </aside>

          <main id="calendarCard" class="card">
            <div class="calHeader">
              <div class="nav">
                <button id="prevBtn" class="btn" title="Previous month">
                  ◀
                </button>
                <button id="todayBtn" class="btn">Go to Jan 2026</button>
                <button id="nextBtn" class="btn" title="Next month">▶</button>
              </div>
              <div class="monthLabel" id="monthLabel">January 2026</div>
              <div class="hint">Click a date to book or unbook</div>
            </div>

            <div class="grid" id="dowRow"></div>
            <div class="grid" id="calendarGrid"></div>

            <div class="list">
              <h4 id="listTitle">All taken leave ranges</h4>
              <div id="rangesList"></div>
            </div>
          </main>
        </div>
      </section>
    </div>

    <!-- Supabase + App -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // 1) Supabase config — replace with your project values
      const SUPABASE_URL = "https://clikohrdkrosjjztxgyn.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsaWtvaHJka3Jvc2pqenR4Z3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MzE1NjEsImV4cCI6MjA3NjQwNzU2MX0.RKt7TgHiMaYAhtaNMA_DYQoTOGimOVAvUSZiwMF53rA";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // 2) Date range
      const START = { y: 2026, m: 0, d: 1 }; // Jan=0
      const END = { y: 2027, m: 0, d: 30 }; // Jan 30, 2027
      const START_DATE = new Date(START.y, START.m, START.d);
      const END_DATE = new Date(END.y, END.m, END.d);
      const DB_RANGE_START = "2026-01-01";
      const DB_RANGE_END = "2027-01-30";

      // 3) Users — your staff and passwords
      const STAFF_COLORS = [
        "#1abc9c",
        "#e74c3c",
        "#3498db",
        "#9b59b6",
        "#f1c40f",
        "#e67e22",
        "#2ecc71",
        "#e84393",
        "#16a085",
        "#34495e",
        "#d35400",
      ];
      const USERS = [
        {
          id: "admin",
          name: "Admin",
          role: "admin",
          password: "Admin@Leave",
          color: "#ffffff",
        },
        {
          id: "s01",
          name: "Ahmed Nabeel",
          role: "staff",
          password: "moNar",
          color: STAFF_COLORS[0],
        },
        {
          id: "s02",
          name: "Ahmed Naufal",
          role: "staff",
          password: "ROpYr",
          color: STAFF_COLORS[1],
        },
        {
          id: "s03",
          name: "Ahmed Falah",
          role: "staff",
          password: "pAGON",
          color: STAFF_COLORS[2],
        },
        {
          id: "s04",
          name: "Ali Rilwan",
          role: "staff",
          password: "naReP",
          color: STAFF_COLORS[3],
        },
        {
          id: "s05",
          name: "Mohamed Salim",
          role: "staff",
          password: "ranGE",
          color: STAFF_COLORS[4],
        },
        {
          id: "s06",
          name: "Ali Shareef",
          role: "staff",
          password: "NFlUD",
          color: STAFF_COLORS[5],
        },
        {
          id: "s07",
          name: "Moosa Mohamed",
          role: "staff",
          password: "iNAtO",
          color: STAFF_COLORS[6],
        },
        {
          id: "s08",
          name: "Ali Arushan",
          role: "staff",
          password: "dviSp",
          color: STAFF_COLORS[7],
        },
        {
          id: "s09",
          name: "Abdulla Rasheed",
          role: "staff",
          password: "THalE",
          color: STAFF_COLORS[8],
        },
        {
          id: "s10",
          name: "Sharafudheen Mohamed",
          role: "staff",
          password: "rcUla",
          color: STAFF_COLORS[9],
        },
        {
          id: "s11",
          name: "Ahmed Ashfaq",
          role: "staff",
          password: "CLeTR",
          color: STAFF_COLORS[10],
        },
      ];
      const USERS_BY_ID = Object.fromEntries(USERS.map((u) => [u.id, u]));

      // 4) State
      let currentUser = null; // {id, name, role, color}
      let leaves = {}; // { 'YYYY-MM-DD': userId }  <- kept in memory, sourced from Supabase
      let view = { y: START.y, m: START.m };
      const STORAGE = { CURRENT_USER: "alp_current_user_v1" };
      let realtimeChannel = null;

      // 5) Utils
      const pad = (n) => (n < 10 ? "0" + n : "" + n);
      const iso = (y, m, d) => `${y}-${pad(m + 1)}-${pad(d)}`;
      const fromISO = (s) => {
        const [Y, M, D] = s.split("-").map(Number);
        return new Date(Y, M - 1, D);
      };
      const fmtLong = (d) =>
        d.toLocaleDateString(undefined, {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      const monthLabel = (y, m) =>
        new Date(y, m, 1).toLocaleDateString(undefined, {
          month: "long",
          year: "numeric",
        });
      const withinRange = (y, m, d) => {
        const dt = new Date(y, m, d);
        return dt >= START_DATE && dt <= END_DATE;
      };
      const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
      const firstDOW = (y, m) => new Date(y, m, 1).getDay();
      const clampViewToRange = () => {
        const cur = new Date(view.y, view.m, 1);
        const min = new Date(START.y, START.m, 1);
        const max = new Date(END.y, END.m, 1);
        if (cur < min) view = { y: START.y, m: START.m };
        if (cur > max) view = { y: END.y, m: END.m };
      };
      const addDays = (date, n) => {
        const d = new Date(date);
        d.setDate(d.getDate() + n);
        return d;
      };
      const isNextDay = (a, b) => {
        const d1 = addDays(fromISO(a), 1);
        const d2 = fromISO(b);
        return (
          d1.getFullYear() === d2.getFullYear() &&
          d1.getMonth() === d2.getMonth() &&
          d1.getDate() === d2.getDate()
        );
      };

      // 6) DOM
      const $login = document.getElementById("login");
      const $loginBtn = document.getElementById("loginBtn");
      const $username = document.getElementById("username");
      const $password = document.getElementById("password");
      const $fillAdmin = document.getElementById("fillAdmin");

      const $header = document.getElementById("appHeader");
      const $rangeHint = document.getElementById("rangeHint");
      const $logout = document.getElementById("logoutBtn");
      const $currentUserName = document.getElementById("currentUserName");
      const $currentUserSwatch = document.getElementById("currentUserSwatch");

      const $app = document.getElementById("app");
      const $legend = document.getElementById("legend");
      const $adminTools = document.getElementById("adminTools");
      const $adminAssign = document.getElementById("adminAssign");
      const $clearAll = document.getElementById("clearAllBtn");

      const $prev = document.getElementById("prevBtn");
      const $next = document.getElementById("nextBtn");
      const $today = document.getElementById("todayBtn");
      const $monthLabel = document.getElementById("monthLabel");
      const $dow = document.getElementById("dowRow");
      const $grid = document.getElementById("calendarGrid");

      const $rangesList = document.getElementById("rangesList");
      const $listTitle = document.getElementById("listTitle");

      // 7) Init
      (async function init() {
        // Populate UI bits
        $username.innerHTML = USERS.map(
          (u) => `<option value="${u.id}">${u.name}</option>`
        ).join("");
        $rangeHint.textContent = `• ${fmtLong(START_DATE)} - ${fmtLong(
          END_DATE
        )}`;
        $dow.innerHTML = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
          .map((d) => `<div class="dow">${d}</div>`)
          .join("");
        $legend.innerHTML = USERS.filter((u) => u.role !== "admin")
          .map(
            (u) => `
      <div class="legendItem"><span class="legendSwatch" style="background:${u.color}"></span><span class="legendName">${u.name}</span></div>
    `
          )
          .join("");
        $adminAssign.innerHTML = [
          `<option value="">— Select —</option>`,
          `<option value="__CLEAR__">CLEAR (remove booking)</option>`,
          ...USERS.filter((u) => u.role !== "admin").map(
            (u) => `<option value="${u.id}">${u.name}</option>`
          ),
        ].join("");

        // Events
        $loginBtn.addEventListener("click", onLogin);
        $fillAdmin.addEventListener("click", () => {
          $username.value = "admin";
          $password.value = "Admin@Leave";
        });
        $logout.addEventListener("click", onLogout);
        $prev.addEventListener("click", () => {
          view.m--;
          if (view.m < 0) {
            view.m = 11;
            view.y--;
          }
          clampViewToRange();
          render();
        });
        $next.addEventListener("click", () => {
          view.m++;
          if (view.m > 11) {
            view.m = 0;
            view.y++;
          }
          clampViewToRange();
          render();
        });
        $today.addEventListener("click", () => {
          view = { y: START.y, m: START.m };
          render();
        });
        $clearAll.addEventListener("click", onClearAll);

        // Load user + leaves from DB
        const savedUserId = localStorage.getItem(STORAGE.CURRENT_USER);
        if (savedUserId && USERS_BY_ID[savedUserId]) {
          currentUser = USERS_BY_ID[savedUserId];
          await loadLeavesFromDB();
          subscribeRealtime();
          showApp();
        } else {
          showLogin();
          // Preload leaves so calendar can display even before login
          await loadLeavesFromDB();
          subscribeRealtime();
        }
      })();

      function showLogin() {
        $login.classList.remove("hidden");
        $app.classList.add("hidden");
        $header.classList.add("hidden");
        $password.value = "";
      }

      function showApp() {
        $login.classList.add("hidden");
        $app.classList.remove("hidden");
        $header.classList.remove("hidden");
        $currentUserName.textContent = currentUser.name;
        $currentUserSwatch.style.background = currentUser.color || "#999";
        $adminTools.classList.toggle("hidden", currentUser.role !== "admin");
        render();
      }

      // 8) Auth (front-end demo only)
      function onLogin() {
        const id = $username.value;
        const pwd = $password.value.trim();
        const user = USERS_BY_ID[id];
        if (!user) return alert("Unknown user.");
        if (pwd !== user.password) return alert("Incorrect password.");

        currentUser = user;
        localStorage.setItem(STORAGE.CURRENT_USER, user.id);
        showApp();
      }

      function onLogout() {
        currentUser = null;
        localStorage.removeItem(STORAGE.CURRENT_USER);
        showLogin();
      }

      // 9) DB: Load + Realtime
      async function loadLeavesFromDB() {
        const { data, error } = await supabase
          .from("leaves")
          .select("date, staff_id")
          .gte("date", DB_RANGE_START)
          .lte("date", DB_RANGE_END);
        if (error) {
          console.error("Error loading leaves:", error);
          return;
        }
        leaves = {};
        for (const row of data) leaves[row.date] = row.staff_id;
        render();
      }

      function subscribeRealtime() {
        if (realtimeChannel) return; // already
        realtimeChannel = supabase
          .channel("leaves-changes")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "leaves" },
            (payload) => {
              const e = payload.eventType;
              if (e === "INSERT" || e === "UPDATE") {
                const row = payload.new;
                leaves[row.date] = row.staff_id;
              } else if (e === "DELETE") {
                const row = payload.old;
                delete leaves[row.date];
              }
              render();
            }
          )
          .subscribe();
      }

      // 10) Render
      function render() {
        $monthLabel.textContent = monthLabel(view.y, view.m);
        renderGrid();
        renderRangesList(); // frozen across months
        updateNavButtons();
      }

      function updateNavButtons() {
        const min = new Date(START.y, START.m, 1);
        const max = new Date(END.y, END.m, 1);
        const cur = new Date(view.y, view.m, 1);
        $prev.disabled = cur <= min;
        $next.disabled = cur >= max;
      }

      function renderGrid() {
        $grid.innerHTML = "";
        const y = view.y,
          m = view.m;
        const first = firstDOW(y, m);
        const dim = daysInMonth(y, m);

        let cells = [];
        const prevMonth = (m - 1 + 12) % 12;
        const prevYear = m === 0 ? y - 1 : y;
        const prevDim = daysInMonth(prevYear, prevMonth);

        // Leading
        for (let i = 0; i < first; i++) {
          const d = prevDim - first + 1 + i;
          cells.push(
            cellHTML(prevYear, prevMonth, d, {
              disabled: true,
              idate: iso(prevYear, prevMonth, d),
              inRange: withinRange(prevYear, prevMonth, d),
            })
          );
        }
        // Current
        for (let d = 1; d <= dim; d++) {
          cells.push(
            cellHTML(y, m, d, {
              disabled: !withinRange(y, m, d),
              idate: iso(y, m, d),
              inRange: true,
            })
          );
        }
        // Trailing
        const remaining = Math.ceil(cells.length / 7) * 7 - cells.length;
        const nextMonth = (m + 1) % 12;
        const nextYear = m === 11 ? y + 1 : y;
        for (let d = 1; d <= remaining; d++) {
          cells.push(
            cellHTML(nextYear, nextMonth, d, {
              disabled: true,
              idate: iso(nextYear, nextMonth, d),
              inRange: withinRange(nextYear, nextMonth, d),
            })
          );
        }

        $grid.innerHTML = cells.join("");
        document.querySelectorAll(".cell").forEach(($c) => {
          if ($c.classList.contains("disabled")) return;
          $c.addEventListener("click", () => onDayClick($c.dataset.date));
        });
      }

      function cellHTML(y, m, d, { disabled, idate }) {
        const now = new Date();
        const isToday =
          now.getFullYear() === y &&
          now.getMonth() === m &&
          now.getDate() === d;
        const bookedBy = leaves[idate];
        const user = bookedBy ? USERS_BY_ID[bookedBy] : null;
        const mine = user && currentUser && user.id === currentUser.id;

        const classes = ["cell"];
        if (disabled) classes.push("disabled");
        if (isToday) classes.push("today");
        if (mine) classes.push("mine");
        if (bookedBy) classes.push("taken");

        const leftStripe = user
          ? `<span class="leftStripe" style="background:${user.color}"></span>`
          : "";
        const pill = user
          ? `<span class="pill" title="Taken by ${user.name}"><span class="name" style="color:${user.color}">${user.name}</span></span>`
          : "";

        return `
      <div class="${classes.join(" ")}" data-date="${idate}" title="${idate}${
          user ? " — " + user.name : ""
        }">
        ${leftStripe}
        <div class="dateNum">${d}</div>
        ${pill}
      </div>
    `;
      }

      // 11) Click handling with Supabase persistence
      async function onDayClick(idate) {
        if (!currentUser) return;
        const isAdmin = currentUser.role === "admin";
        const bookedBy = leaves[idate];

        if (isAdmin) {
          const sel = $adminAssign.value;
          if (!sel) {
            if (bookedBy) {
              const u = USERS_BY_ID[bookedBy];
              if (
                confirm(
                  `${fmtLong(fromISO(idate))} is taken by ${u.name}. Clear it?`
                )
              ) {
                await dbDeleteDay(idate);
              }
            }
            return;
          }
          if (sel === "__CLEAR__") {
            if (bookedBy) await dbDeleteDay(idate);
            return;
          }
          // Assign
          if (bookedBy && bookedBy !== sel) {
            const fromU = USERS_BY_ID[bookedBy];
            const toU = USERS_BY_ID[sel];
            const ok = confirm(
              `Reassign ${fmtLong(fromISO(idate))} from ${fromU.name} to ${
                toU.name
              }?`
            );
            if (!ok) return;
          }
          await dbUpsertDay(idate, sel);
          return;
        }

        // Staff: toggle own booking
        if (!bookedBy) {
          await dbInsertDay(idate, currentUser.id); // will fail if race; DB constraint protects
          return;
        }
        if (bookedBy === currentUser.id) {
          await dbDeleteDay(idate);
          return;
        }
        const u = USERS_BY_ID[bookedBy];
        alert(
          `${fmtLong(fromISO(idate))} is already taken by ${
            u.name
          }. Overlapping leaves are not allowed.`
        );
      }

      // 12) DB helpers
      async function dbInsertDay(dateISO, staffId) {
        // Try insert; handle unique violation if someone else just booked it
        const { error } = await supabase
          .from("leaves")
          .insert({ date: dateISO, staff_id: staffId });
        if (error) {
          if (error.code === "23505") {
            alert(
              `${fmtLong(fromISO(dateISO))} was just booked by someone else.`
            );
          } else {
            console.error("Insert error:", error);
            alert("Could not save. Please try again.");
          }
        }
      }
      async function dbUpsertDay(dateISO, staffId) {
        const { error } = await supabase
          .from("leaves")
          .upsert({ date: dateISO, staff_id: staffId }, { onConflict: "date" });
        if (error) {
          console.error("Upsert error:", error);
          alert("Could not assign. Please try again.");
        }
      }
      async function dbDeleteDay(dateISO) {
        const { error } = await supabase
          .from("leaves")
          .delete()
          .eq("date", dateISO);
        if (error) {
          console.error("Delete error:", error);
          alert("Could not remove. Please try again.");
        }
      }

      // 13) Frozen list of all leave ranges
      function renderRangesList() {
        const entries = Object.entries(leaves)
          .filter(([date, uid]) => !!USERS_BY_ID[uid])
          .sort((a, b) => (a[0] < b[0] ? -1 : 1)); // sort by date

        // Group consecutive days per staff
        const ranges = [];
        let cur = null;
        for (const [dateStr, uid] of entries) {
          if (!cur) {
            cur = { uid, start: dateStr, end: dateStr };
            continue;
          }
          if (uid === cur.uid && isNextDay(cur.end, dateStr)) {
            cur.end = dateStr; // extend
          } else {
            ranges.push(cur);
            cur = { uid, start: dateStr, end: dateStr };
          }
        }
        if (cur) ranges.push(cur);

        // Sort ranges by start date
        ranges.sort((r1, r2) =>
          r1.start < r2.start ? -1 : r1.start > r2.start ? 1 : 0
        );

        $listTitle.textContent = `All taken leave ranges (${fmtLong(
          START_DATE
        )} — ${fmtLong(END_DATE)})`;
        if (ranges.length === 0) {
          $rangesList.innerHTML = `<div class="hint">No leave ranges yet.</div>`;
          return;
        }
        $rangesList.innerHTML = ranges
          .map((r) => {
            const u = USERS_BY_ID[r.uid];
            const start = fmtLong(fromISO(r.start));
            const end = fmtLong(fromISO(r.end));
            return `
        <div class="listItem" title="${u.name}: ${start} to ${end}">
          <span class="whoDot" style="background:${u.color}"></span>
          <span class="whoName">${u.name}</span>
          <span class="rangeText">— ${start} → ${end}</span>
        </div>
      `;
          })
          .join("");
      }

      // 14) Admin: clear all bookings in range
      async function onClearAll() {
        const count = Object.keys(leaves).length;
        if (count === 0) {
          alert("There are no bookings to clear.");
          return;
        }
        const ok = confirm(
          `Clear all ${count} booking(s) between ${DB_RANGE_START} and ${DB_RANGE_END}?`
        );
        if (!ok) return;
        const { error } = await supabase
          .from("leaves")
          .delete()
          .gte("date", DB_RANGE_START)
          .lte("date", DB_RANGE_END);
        if (error) {
          console.error("Clear all error:", error);
          alert("Could not clear bookings. Check policies and try again.");
        }
      }
    </script>
  </body>
</html>
